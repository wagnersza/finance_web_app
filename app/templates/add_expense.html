{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>Nova Despesa</h1>
    <form method="POST" action="{{ url_for('main.add_expense') }}" class="expense-form">
        <div class="form-group">
            <label for="description">Descrição</label>
            <input type="text" id="description" name="description" required class="form-control">
        </div>
        
        <div class="form-group">
            <label for="category_id">Categoria</label>
            <div class="input-group">
                <select id="category_id" name="category_id" required class="form-control">
                    <option value="">Selecione uma categoria</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newCategoryModal">
                    <i class="bi bi-plus"></i> Nova
                </button>
            </div>
        </div>
        
        <div class="form-group">
            <label for="account_id">Conta</label>
            <div class="input-group">
                <select id="account_id" name="account_id" required class="form-control">
                    <option value="">Selecione uma conta</option>
                    {% for account in accounts %}
                    <option value="{{ account.id }}">{{ account.name }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newAccountModal">
                    <i class="bi bi-plus"></i> Nova
                </button>
            </div>
        </div>

        <div class="form-group">
            <label for="amount">Valor</label>
            <div class="input-group">
                <span class="input-group-text currency-symbol"></span>
                <input type="text" 
                       id="amount" 
                       name="amount" 
                       required 
                       class="form-control text-end" 
                       placeholder="0,00"
                       pattern="[0-9]*[.,]?[0-9]{0,2}"
                       inputmode="decimal"
                       lang="pt-BR">
            </div>
            <small class="form-text text-muted">Use ponto ou vírgula para decimais (ex: 10.50 ou 10,50)</small>
        </div>
        
        <button type="submit" class="btn btn-primary">Adicionar Despesa</button>
        <a href="{{ url_for('main.expenses') }}" class="btn btn-secondary">Cancelar</a>
    </form>
</div>

<!-- Modal Sections -->
{% include 'modals/category_modal.html' %}
{% include 'modals/account_modal.html' %}
{% include 'modals/bank_modal.html' %}
{% include 'modals/currency_modal.html' %}
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
<script>
// Ensure Bootstrap is loaded before initializing
window.addEventListener('load', function() {
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap is not loaded');
        return;
    }

    // Initialize all modals with specific options for Safari
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        const modalInstance = new bootstrap.Modal(modal, {
            backdrop: 'static', // Prevent closing on backdrop click
            keyboard: true,
            focus: true
        });

        // Handle Safari-specific modal stacking
        modal.addEventListener('shown.bs.modal', function() {
            document.body.classList.add('modal-open');
        });

        modal.addEventListener('hidden.bs.modal', function() {
            setTimeout(() => {
                if (document.querySelector('.modal.show')) {
                    document.body.classList.add('modal-open');
                }
            }, 10);
        });
    });

    // Handle modal buttons with explicit show/hide
    document.querySelectorAll('[data-bs-toggle="modal"]').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            const targetModalId = this.getAttribute('data-bs-target');
            const targetModal = document.querySelector(targetModalId);
            if (targetModal) {
                const modalInstance = bootstrap.Modal.getInstance(targetModal) || new bootstrap.Modal(targetModal);
                modalInstance.show();
            }
        });
    });

    // Amount input handling
    const amountInput = document.getElementById('amount');
    const accountSelect = document.getElementById('account_id');
    const currencySymbolElement = document.querySelector('.currency-symbol');
    let currentCurrencySymbol = '';

    function updateAmountFormat() {
        const accountId = accountSelect.value;
        if (accountId) {
            try {
                const accounts = JSON.parse('{{ accounts|tojson|safe }}');
                const currencies = JSON.parse('{{ currencies|tojson|safe }}');
                const account = accounts.find(a => a.id == accountId);
                if (account) {
                    const currency = currencies.find(c => c.id == account.currency_id);
                    if (currency) {
                        currentCurrencySymbol = currency.symbol;
                        currencySymbolElement.textContent = currency.symbol;
                        amountInput.placeholder = '0,00';
                    }
                }
            } catch (e) {
                console.error('Error updating amount format:', e);
            }
        }
    }

    accountSelect.addEventListener('change', updateAmountFormat);

    amountInput.addEventListener('input', function(e) {
        let value = e.target.value;
        
        // Remove any non-numeric characters except dot and comma
        value = value.replace(/[^\d.,]/g, '');
        
        // Replace comma with dot for internal processing
        value = value.replace(',', '.');
        
        // Ensure only one decimal point
        const parts = value.split('.');
        if (parts.length > 2) {
            value = parts[0] + '.' + parts.slice(1).join('');
        }
        
        // Format to 2 decimal places if there's a decimal point
        if (value.includes('.')) {
            const decimals = value.split('.')[1];
            if (decimals.length > 2) {
                value = parseFloat(value).toFixed(2);
            }
        }
        
        e.target.value = value;
    });

    // Format on form submission
    document.querySelector('form').addEventListener('submit', function(e) {
        let value = amountInput.value;
        if (value) {
            // Replace comma with dot for final processing
            value = value.replace(',', '.');
            // Ensure proper decimal format
            amountInput.value = parseFloat(value).toFixed(2);
        }
    });

    // Initial setup
    updateAmountFormat();
});
</script>
{% endblock %}